# 2024-12-19 开发日志

## 今日目标
实现聊天机器人API系统的基础架构，包括用户管理、会话管理、消息处理和测试界面。

## 完成的工作

### 1. 数据库架构设计与实现
**文件**: `database/chatbot_schema.sql`

#### 核心表结构
- **chat_users**: 聊天用户表（终端用户）
- **chat_user_tags**: 用户标签表 
- **chat_user_tag_relations**: 用户标签关联表
- **chat_sessions**: 聊天会话表
- **chat_messages**: 聊天消息表（明文存储）
- **chat_vectors**: 聊天向量表（向量化存储）

#### 关键设计决策
1. **用户概念明确分离**: 
   - `users` 表 → 后台管理员
   - `chat_users` 表 → 聊天机器人终端用户

2. **消息双重存储架构**:
   - `chat_messages` → 明文存储，用于界面显示
   - `chat_vectors` → 向量化存储，用于相似性检索

3. **消息合并机制**:
   - `is_processed` 字段标记消息处理状态
   - `message_merge_seconds` 配置合并时间间隔
   - `merge_group_id` 标识合并的消息组

#### 数据库函数
- `get_pending_message_count()`: 获取待处理消息数量
- `get_sessions_needing_processing()`: 获取需要处理的会话
- `get_sessions_needing_topics()`: 获取需要话题推送的会话
- `get_user_tags()`: 获取用户标签
- `add_user_tag()`: 添加用户标签

### 2. LLM服务封装
**文件**: `src/lib/llm-service.ts`

#### 功能特性
- 使用OpenAI API实现聊天补全
- 支持基于消息历史的对话
- 支持文本embedding生成
- 错误处理和响应格式统一

#### 配置参数
```javascript
const DEFAULT_LLM_SETTINGS = {
  messageMergeSeconds: 300,      // 5分钟
  topicTriggerHours: 24,         // 24小时
  maxChatHistory: 10,            // 最多10条历史
  knowledgeSearchLimit: 5,       // 最多5条知识库结果
  llmMaxTokens: 2000,           // LLM最大Token数
  llmTemperature: 0.7,          // LLM温度参数
  llmModel: 'gpt-3.5-turbo'     // 默认模型
};
```

### 3. API接口实现

#### 用户管理API (`/api/chat/users`)
**功能**: CRUD操作，支持用户标签管理
- `GET`: 获取用户列表/单个用户详情（含标签）
- `POST`: 创建新用户，自动分配"新用户"标签
- `PUT`: 更新用户信息
- `DELETE`: 软删除用户

#### 会话管理API (`/api/chat/sessions`)
**功能**: 聊天会话生命周期管理
- `GET`: 获取会话列表/单个会话详情
- `POST`: 创建新会话，支持配置消息合并时间和话题推送设置
- `PUT`: 更新会话设置
- `DELETE`: 软删除会话

#### 消息处理API (`/api/chat/message`)
**功能**: 核心消息处理逻辑
- `POST`: 发送消息（不立即处理，排队等待）
- `GET`: 获取会话消息历史
- `PUT`: 批量处理待处理消息，调用LLM生成回复

#### 消息处理流程
1. 用户发送消息 → 存储为 `is_processed=false`
2. 更新会话 `last_message_at` 时间戳
3. 定时检查或手动触发处理
4. 合并未处理的用户消息
5. 获取聊天历史上下文
6. 构建系统Prompt（包含机器人人设）
7. 调用LLM生成回复
8. 存储AI回复并标记原消息为已处理
9. 生成合并组ID关联相关消息

### 4. 测试界面开发
**文件**: `src/app/test-chat/page.tsx`

#### 功能模块
- **用户管理**: 创建用户、选择用户
- **会话管理**: 输入会话ID（测试用）
- **消息发送**: 实时发送消息到会话
- **消息处理**: 手动触发消息批量处理
- **实时聊天**: 展示对话历史
- **操作日志**: 记录所有API调用结果

#### 用户体验
- 左侧控制面板：用户选择、会话管理、操作按钮
- 右侧聊天区域：消息显示、输入框、操作日志
- 实时状态显示：未处理消息标记、处理结果反馈

## 遇到的问题与解决方案

### 1. 消息合并时机控制
**问题**: 用户可能连续发送多条消息，需要避免频繁调用LLM

**解决方案**: 
- 引入 `message_merge_seconds` 配置
- 消息发送时只存储，不立即处理
- 定时检查或手动触发批量处理
- 支持强制处理模式用于测试

### 2. 用户概念混淆
**问题**: 原有 `users` 表是管理员用户，与聊天用户概念冲突

**解决方案**:
- 新建 `chat_users` 表专门存储聊天终端用户
- 保持 `users` 表用于后台管理员
- 明确区分两种用户类型的使用场景

### 3. 人设系统集成
**问题**: 需要将现有的机器人人设系统集成到聊天流程

**解决方案**:
- 会话表中关联 `bot_personality_id`
- 在LLM调用时动态构建系统Prompt
- 包含人设的姓名、性格、兴趣等信息

### 4. 测试便利性
**问题**: 需要快速测试各种API和设置

**解决方案**:
- 创建专门的测试页面
- 集成所有核心功能的操作界面
- 提供实时日志反馈
- 支持直接输入会话ID进行测试

## 技术债务

1. **错误处理完善**: API错误信息需要更详细的分类
2. **数据验证**: 输入参数验证需要更严格
3. **性能优化**: 消息历史查询可能需要分页优化
4. **定时任务**: 消息处理和话题推送的定时任务尚未实现
5. **知识库集成**: 尚未与现有知识库检索系统集成
6. **向量化存储**: 消息向量化功能尚未完整实现

## 重要问题修复

### 问题：向量检索未集成到聊天流程
**发现时间**: 2024-12-19 下午

#### 问题描述
用户报告虽然在测试面板中设置了RAG阈值参数，但实际聊天时AI回复与话术库内容无关。经分析发现：

1. **参数传递但未使用**: `similarity_threshold` 和 `history_limit` 参数传递到API但未被使用
2. **向量搜索API孤立**: `/api/search` 接口存在且功能正常，但聊天流程中没有调用
3. **Prompt构建缺乏知识库上下文**: 原来的Prompt只包含机器人人设，没有整合知识库内容

#### 修复方案
**文件**: `src/app/api/chat/message/route.ts`

1. **添加内部向量搜索函数**: 避免HTTP调用开销，直接在消息处理中进行向量检索
2. **集成知识库检索到聊天流程**: 在调用LLM之前先搜索相关知识
3. **智能Prompt构建策略**:
   - 相似度 ≥ 0.8: 强制使用话术标准回答，不允许添加额外内容
   - 相似度 ≥ 0.6: 建议使用话术回答，保持一致性
   - 相似度 < 0.6: 提供参考信息，允许灵活回答

#### 修复后的Prompt构建逻辑
```typescript
// 非常高相似度 (≥0.8)
knowledgeContext = `
这是一个标准话术场景，相似度${similarity.toFixed(3)}。
必须直接回答："${scriptAnswer}"
不要添加任何解释、分析或额外内容，只需要输出这个标准回答。`;

// 高相似度 (≥0.6)
knowledgeContext = `
根据话术库，对于这类问题的标准回答是："${scriptAnswer}"
请直接使用这个回答，保持简洁和一致性。`;

// 低相似度 (<0.6)
knowledgeContext = `
参考相关信息：${referenceInfo}
请参考以上信息回答用户问题。如果有相似的问题和回答，可以参考其风格和内容。`;
```

#### 增强的监控和日志
1. **API响应增强**: 添加 `knowledgeUsed` 标志和详细的向量检索元数据
2. **测试面板改进**: 显示向量检索结果、相似度信息和使用模式
3. **调试信息**: 记录检索到的知识条数、最高相似度等关键指标

### 测试验证
修复后的系统应该能够：
- 对于高相似度匹配（如"我喜欢打瓦"），直接返回话术库中的标准回答
- 根据相似度自动调整回答策略
- 在测试面板中显示详细的向量检索过程信息
- 保持原有的聊天功能，向量检索失败时不影响正常对话

## 下一步计划

### 短期（1-2天）
1. 运行数据库迁移脚本
2. 配置OpenAI API密钥
3. 测试基础的聊天流程
4. 修复测试中发现的bug

### 中期（3-7天）
1. 集成现有的知识库检索系统
2. 实现消息向量化存储
3. 添加定时任务处理机制
4. 实现话题推送功能

### 长期（1-2周）
1. 切换到云服务器LLM
2. 实现基于对话内容的自动标签系统
3. 添加聊天数据分析功能
4. 性能优化和扩展性改进

## 配置要求

### 环境变量
```bash
# .env.local
OPENAI_API_KEY=your_openai_api_key
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 数据库迁移
需要在Supabase中执行 `database/chatbot_schema.sql`

## 测试说明

1. 访问 `/test-chat` 页面
2. 先创建一个聊天用户
3. 输入会话ID（可以是任意UUID）
4. 发送消息测试
5. 点击"处理消息"触发LLM回复

## 代码质量

- 遵循TypeScript严格模式
- API响应格式统一
- 错误处理统一
- 代码注释完整
- 数据库操作使用事务保证一致性 