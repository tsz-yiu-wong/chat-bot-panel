# 消息向量化逻辑规则

## 向量类型和内容格式

### 1. Message向量 - 基础内容（包含角色前缀）
**格式**: 
- 用户消息: `user: [消息内容]`
- AI回复: `assistant: [回复内容]`

**目的**: 提供带角色区分的内容检索
- 避免用户问题和AI回答的语义混淆
- 支持按角色类型过滤检索结果
- 保持原始内容的完整性
- **用户和AI消息都创建message向量**

### 2. Context向量 - 完整对话上下文
**格式**: `user: [对应的用户消息] | assistant: [AI回复内容]`

**目的**: 提供完整对话检索
- **只为AI回复创建context向量**
- 保存完整的问答对，支持相似对话检索
- 使用`|`分隔符区分用户输入和AI回复
- 避免与message向量重复

## 向量创建策略

### 每条消息的向量数量
- **用户消息**: 1个message向量
- **AI回复**: 1个message向量 + 1个context向量

### 设计理念
- **Message向量**: 单独内容检索（用户问题检索、AI回答检索）
- **Context向量**: 对话模式检索（完整问答对检索）
- **避免冗余**: 用户消息不需要context向量，因为message向量已经包含了完整信息

## 触发时机

### 自动触发
1. **用户消息**: 当`is_processed`从`false`变为`true`时创建1个message向量
2. **AI回复**: 插入时立即创建1个message向量 + 1个context向量

### 手动触发
- 批量向量化API：`/api/chat/vectors/batch`
- 支持指定session_id或处理所有未向量化消息

## 上下文匹配逻辑

### AI回复的用户消息查找策略
1. **优先级1**: 使用`merge_group_id`查找同组的所有用户消息
2. **优先级2**: 查找同session中时间最近的已处理用户消息
3. **兜底**: 如果找不到，user部分为空字符串

### 消息合并处理
- 同一`merge_group_id`的多条用户消息用空格连接
- 保持消息时间顺序
- 只处理`is_processed = true`的消息

## 检索配置
- **相似度阈值**: 0.6 (可在ai-config.ts中调整)
- **返回数量**: 5条相关消息
- **向量模型**: OpenAI text-embedding-3-small
- **距离计算**: 余弦相似度

## 异步处理
- 向量创建不阻塞消息存储
- embedding字段初始为NULL，由API异步生成
- 支持批量处理提高效率

## 数据库优化
- session_id + vector_type + message_id联合索引
- embedding字段使用vector类型（支持相似度查询）
- 自动更新时间戳记录处理时间 