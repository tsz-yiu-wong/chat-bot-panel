# 聊天机器人管理系统功能地图

## 系统架构概览

```mermaid
graph TB
    subgraph "用户认证层"
        A[用户认证系统]
        A1[登录验证]
        A2[权限控制]
        A3[会话管理]
        A --> A1
        A --> A2
        A --> A3
    end
    
    subgraph "核心功能层"
        B[知识库管理]
        C[话题管理]
        D[提示词管理]
        E[机器人管理]
        F[仪表板]
        G[设置管理]
    end
    
    subgraph "数据层"
        H[用户数据库]
        I[知识库数据库]
        J[话题数据库]
        K[提示词数据库]
    end
    
    subgraph "外部服务"
        L[OpenAI API]
        M[Supabase]
        N[pgvector]
    end
    
    A2 --> B
    A2 --> C
    A2 --> D
    A2 --> E
    A2 --> F
    A2 --> G
    
    B --> I
    C --> J
    D --> K
    E --> K
    E --> J
    E --> I
    
    A --> H
    B --> L
    B --> N
    
    H --> M
    I --> M
    J --> M
    K --> M
```

## 功能模块详细地图

### 1. 用户认证系统 🔐

**核心职责**: 系统安全守护，权限控制中心

```mermaid
graph LR
    A[用户认证系统] --> B[登录页面]
    A --> C[用户管理页面]
    A --> D[权限验证Hook]
    A --> E[会话管理]
    
    B --> B1[用户名密码验证]
    B --> B2[错误处理]
    B --> B3[登录重定向]
    
    C --> C1[用户CRUD操作]
    C --> C2[角色管理]
    C --> C3[密码重置]
    
    D --> D1[页面权限检查]
    D --> D2[功能权限控制]
    D --> D3[路由守护]
    
    E --> E1[localStorage管理]
    E --> E2[自动登出]
    E --> E3[会话恢复]
```

**权限级别**:
- `super_admin`: 完全访问权限
- `admin`: 管理所有业务功能
- `operator`: 管理知识库和话题
- `viewer`: 仅查看用户信息

**依赖关系**:
- **数据依赖**: `users`表
- **技术依赖**: Supabase认证、bcrypt加密
- **被依赖**: 所有其他功能模块

---

### 2. 知识库管理系统 🧠

**核心职责**: AI智能检索，知识内容管理

```mermaid
graph LR
    A[知识库管理] --> B[缩写库]
    A --> C[话术库]
    A --> D[向量搜索]
    A --> E[向量测试]
    
    B --> B1[分类管理]
    B --> B2[缩写CRUD]
    B --> B3[搜索筛选]
    
    C --> C1[场景管理]
    C --> C2[话术CRUD]
    C --> C3[对话模板]
    
    D --> D1[OpenAI Embedding]
    D --> D2[相似度搜索]
    D --> D3[向量同步]
    
    E --> E1[实时检索测试]
    E --> E2[相似度调试]
    E --> E3[效果评估]
```

**技术特色**:
- **AI驱动**: OpenAI Embedding自动向量化
- **智能检索**: 语义相似度搜索
- **双模式**: 结构化存储 + 向量化检索
- **实时同步**: 数据变更自动更新向量

**依赖关系**:
- **权限依赖**: `operator`及以上权限
- **数据依赖**: `knowledge_abbreviations`, `knowledge_scripts`, `knowledge_vectors`
- **技术依赖**: OpenAI API, pgvector扩展
- **API端点**: `/api/search`, `/api/vectorize`

---

### 3. 话题管理系统 💬

**核心职责**: 对话内容组织，三级分类管理

```mermaid
graph LR
    A[话题管理] --> B[大类管理]
    A --> C[小类管理]  
    A --> D[话题管理]
    A --> E[搜索定位]
    
    B --> B1[中越双语名称]
    B --> B2[排序管理]
    B --> B3[统计信息]
    
    C --> C1[大类关联]
    C --> C2[双语支持]
    C --> C3[层级展示]
    
    D --> D1[分类归属]
    D --> D2[内容编辑]
    D --> D3[使用统计]
    
    E --> E1[关键词搜索]
    E --> E2[自动展开]
    E --> E3[结果高亮]
```

**设计特色**:
- **三级结构**: 大类 → 小类 → 具体话题
- **双语支持**: 中文/越南语并行管理
- **智能交互**: 展开/收起、搜索定位
- **排序灵活**: 从1000开始的排序系统

**依赖关系**:
- **权限依赖**: `operator`及以上权限
- **数据依赖**: `topic_categories`, `topic_subcategories`, `topics`
- **级联关系**: 删除大类自动删除小类和话题

---

### 4. 提示词管理系统 📝

**核心职责**: AI对话引导，多阶段模板管理

```mermaid
graph LR
    A[提示词管理] --> B[阶段管理]
    A --> C[模型适配]
    A --> D[双语内容]
    A --> E[筛选系统]
    
    B --> B1[初识阶段]
    B --> B2[了解爱好]
    B --> B3[加深感情]
    B --> B4[恋爱模式]
    
    C --> C1[qwen3-32B]
    C --> C2[gemma3-27B]
    C --> C3[模型优化]
    
    D --> D1[中文提示词]
    D --> D2[越南语提示词]
    D --> D3[备注说明]
    
    E --> E1[阶段筛选]
    E --> E2[模型筛选]
    E --> E3[组合筛选]
```

**设计特色**:
- **阶段化**: 按对话发展阶段组织
- **色彩编码**: 不同阶段使用专属颜色
- **智能展开**: 长内容自动折叠/展开
- **筛选统计**: 实时显示筛选结果数量

**依赖关系**:
- **权限依赖**: `operator`及以上权限
- **数据依赖**: `prompts`表
- **功能关联**: 为机器人管理提供模板支持

---

### 5. 机器人管理系统 🤖

**核心职责**: 聊天机器人配置，综合功能整合  
**状态**: ✅ 已实现 | **最后更新**: 2024-12-19

```mermaid
graph LR
    A[机器人管理] --> B[机器人配置]
    A --> C[人设管理]
    A --> D[图片管理]
    A --> E[软删除管理]
    
    B --> B1[基础信息]
    B --> B2[个性设定]
    B --> B3[生活习惯]
    
    C --> C1[详细人设]
    C --> C2[多语言支持]
    C --> C3[个性化配置]
    
    D --> D1[多类型图片]
    D --> D2[图片分类管理]
    D --> D3[软删除保护]
    
    E --> E1[级联软删除]
    E --> E2[数据保护]
    E --> E3[恢复支持]
```

**技术特色**:
- **多维人设**: 涵盖基础信息、生活习惯、价值观等多个维度
- **图片分类**: 支持个人、生活、工作、爱好、旅行等多种类型
- **软删除保护**: 机器人和图片均支持软删除，数据安全可恢复
- **乐观更新**: 删除操作即时响应，失败自动回滚

**依赖关系**:
- **权限依赖**: `operator`及以上权限
- **数据依赖**: `bot_personalities`, `bot_images`表
- **文件存储**: Supabase Storage集成
- **软删除统一**: 使用 `is_deleted` 字段统一管理

---

### 6. 仪表板系统 📊

**核心职责**: 数据概览，系统状态监控

```mermaid
graph LR
    A[仪表板] --> B[数据概览]
    A --> C[使用统计]
    A --> D[系统状态]
    A --> E[快速操作]
    
    B --> B1[用户数量]
    B --> B2[知识条目]
    B --> B3[话题数量]
    B --> B4[提示词数量]
    
    C --> C1[活跃度分析]
    C --> C2[功能使用率]
    C --> C3[增长趋势]
    
    D --> D1[服务状态]
    D --> D2[API健康度]
    D --> D3[性能指标]
    
    E --> E1[快速添加]
    E --> E2[批量操作]
    E --> E3[常用功能]
```

**分析特色**:
- **全局视角**: 系统整体数据概览
- **趋势分析**: 历史数据变化趋势
- **健康监控**: 系统服务状态监控
- **快速入口**: 常用功能快速访问

**依赖关系**:
- **权限依赖**: `viewer`及以上权限
- **数据依赖**: 所有模块的统计数据
- **展示层**: 汇总展示各模块核心指标

---

### 7. 设置管理系统 ⚙️

**核心职责**: 系统配置，高级管理功能

```mermaid
graph LR
    A[设置管理] --> B[系统配置]
    A --> C[API管理]
    A --> D[数据管理]
    A --> E[安全设置]
    
    B --> B1[基础设置]
    B --> B2[界面配置]
    B --> B3[功能开关]
    
    C --> C1[OpenAI配置]
    C --> C2[API密钥管理]
    C --> C3[服务限制]
    
    D --> D1[数据备份]
    D --> D2[批量导入]
    D --> D3[清理工具]
    
    E --> E1[密码策略]
    E --> E2[会话管理]
    E --> E3[审计日志]
```

**管理特色**:
- **高级配置**: 系统级参数设置
- **API管理**: 外部服务密钥和配置
- **数据工具**: 备份、导入、清理功能
- **安全策略**: 密码、会话、审计管理

**依赖关系**:
- **权限依赖**: `super_admin`权限
- **系统级**: 影响整个系统的配置和行为
- **维护工具**: 提供系统维护和管理工具

## 数据流向图

```mermaid
graph TD
    subgraph "前端层"
        A[登录页面] --> B[仪表板]
        B --> C[知识库管理]
        B --> D[话题管理]
        B --> E[提示词管理]
        B --> F[机器人管理]
        B --> G[用户管理]
        B --> H[设置管理]
    end
    
    subgraph "API层"
        I[认证API]
        J[搜索API]
        K[向量化API]
        L[数据CRUD API]
    end
    
    subgraph "数据库层"
        M[(users)]
        N[(knowledge_*)]
        O[(topic_*)]
        P[(prompts)]
    end
    
    subgraph "外部服务层"
        Q[OpenAI API]
        R[Supabase]
    end
    
    A --> I
    C --> J
    C --> K
    C --> L
    D --> L
    E --> L
    F --> L
    G --> L
    
    I --> M
    J --> N
    K --> N
    L --> M
    L --> N
    L --> O
    L --> P
    
    K --> Q
    M --> R
    N --> R
    O --> R
    P --> R
```

## 技术栈依赖关系

```mermaid
graph TB
    subgraph "前端技术栈"
        A[Next.js 14]
        B[React 18]
        C[TypeScript]
        D[Tailwind CSS]
        E[Shadcn/ui]
    end
    
    subgraph "后端技术栈"
        F[Supabase]
        G[PostgreSQL]
        H[pgvector]
        I[bcrypt]
    end
    
    subgraph "外部服务"
        J[OpenAI API]
        K[Vercel部署]
    end
    
    A --> B
    A --> C
    B --> D
    B --> E
    
    F --> G
    G --> H
    G --> I
    
    A --> F
    F --> J
    A --> K
```

## 部署架构图

```mermaid
graph TB
    subgraph "用户层"
        A[Web浏览器]
        B[移动设备]
    end
    
    subgraph "CDN层"
        C[Vercel CDN]
    end
    
    subgraph "应用层"
        D[Next.js应用]
        E[API路由]
    end
    
    subgraph "数据层"
        F[Supabase数据库]
        G[pgvector扩展]
    end
    
    subgraph "外部服务"
        H[OpenAI API]
    end
    
    A --> C
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    E --> H
```

## 功能模块统计

| 模块 | 状态 | 权限要求 | 主要文件 | 依赖服务 |
|------|------|----------|----------|----------|
| 用户认证 | ✅ 已完成 | - | `page.tsx`, `users/page.tsx` | Supabase |
| 知识库管理 | ✅ 已完成 | operator+ | `knowledge/page.tsx` | OpenAI, pgvector |
| 话题管理 | ✅ 已完成 | operator+ | `topics/page.tsx` | Supabase |
| 提示词管理 | ✅ 已完成 | operator+ | `prompts/page.tsx` | Supabase |
| 机器人管理 | ✅ 已完成 | operator+ | `bots/page.tsx` | Supabase Storage |
| 仪表板 | 🚧 规划中 | viewer+ | `dashboard/page.tsx` | 数据聚合 |
| 设置管理 | 🚧 规划中 | super_admin | `settings/page.tsx` | 系统配置 |

## 核心API端点

| 端点 | 方法 | 功能 | 权限 | 依赖模块 |
|------|------|------|------|----------|
| `/api/search` | POST | 向量搜索 | operator+ | 知识库, OpenAI |
| `/api/vectorize` | POST/DELETE | 向量化管理 | operator+ | 知识库, OpenAI |
| `/api/bot-personality` | GET/POST/PUT/DELETE | 机器人CRUD | operator+ | 机器人管理 |
| `/api/bot-personality/images` | GET/POST/PUT/DELETE | 机器人图片管理 | operator+ | 机器人管理, Storage |
| `/` | POST | 用户登录 | - | 用户认证 |
| `/users` | GET/POST/PUT/DELETE | 用户管理 | admin+ | 用户认证 |
| `/knowledge` | GET/POST/PUT/DELETE | 知识库CRUD | operator+ | 知识库 |
| `/topics` | GET/POST/PUT/DELETE | 话题CRUD | operator+ | 话题管理 |
| `/prompts` | GET/POST/PUT/DELETE | 提示词CRUD | operator+ | 提示词管理 |

## 下一步开发规划

### 短期目标 (1-2周)
1. **完善机器人管理功能**
   - 机器人配置界面
   - 多模块数据整合
   - 对话流程配置

2. **实现仪表板功能**
   - 数据统计概览
   - 使用趋势分析
   - 系统状态监控

### 中期目标 (1个月)
1. **增强设置管理**
   - 系统配置界面
   - API密钥管理
   - 数据备份工具

2. **性能优化**
   - 数据库查询优化
   - 前端性能提升
   - 缓存策略实现

### 长期目标 (3个月)
1. **安全增强**
   - 审计日志系统
   - 双因素认证
   - API安全加固

2. **功能扩展**
   - 多语言支持扩展
   - 高级分析功能
   - 自动化工具

## 维护和监控

### 日常维护
- [ ] 数据库性能监控
- [ ] API响应时间检查
- [ ] 用户活动日志审查
- [ ] 知识库质量评估

### 定期任务
- [ ] 数据备份验证
- [ ] 安全漏洞扫描
- [ ] 依赖包更新
- [ ] 性能优化分析

### 紧急响应
- [ ] 系统故障快速恢复
- [ ] 数据丢失应急处理
- [ ] 安全事件响应流程
- [ ] 用户支持快速通道

---

**文档版本**: v1.0  
**最后更新**: 2024年12月
**维护者**: 开发团队 

## 数据架构升级

### 软删除机制 (2024-12-19)
**影响范围**: 全系统核心功能  
**技术实现**:
- 数据库字段: `is_deleted BOOLEAN DEFAULT FALSE`
- 查询过滤: 所有SELECT添加 `WHERE is_deleted = false`
- 删除操作: `DELETE` → `UPDATE SET is_deleted = true`
- 级联处理: 话题库三层级级联软删除
- 向量同步: 知识库向量数据硬删除保证搜索准确性

**受影响表**:
- `knowledge_abbreviations`
- `knowledge_scripts` 
- `topic_categories`
- `topic_subcategories`
- `topics`
- `prompts`

**性能优化**:
- 添加 `is_deleted` 字段索引
- 复合索引支持级联查询
- `!inner` JOIN 优化关联查询

## 技术债务记录

### 已解决 ✅
- 软删除机制缺失 → 已实施完整软删除方案 (2024-12-19)
- 话题库级联删除数据一致性 → 已实现事务级联软删除 (2024-12-19)
- 知识库向量数据同步问题 → 软删除时同步硬删除向量 (2024-12-19)

### 待优化 🔄
- 软删除数据恢复功能 (计划中)
- 定期数据清理机制 (计划中)
- 删除操作审计日志 (计划中)

## 功能依赖关系

```
软删除机制 (核心)
├── 知识库管理
│   ├── 缩写库软删除 + 向量同步删除
│   └── 话术库软删除 + 向量同步删除
├── 话题库管理  
│   ├── 大类软删除 → 级联软删除小类和话题
│   ├── 小类软删除 → 级联软删除话题
│   └── 话题独立软删除
└── 提示词管理
    └── 独立软删除
```

## 下一步开发计划

### 优先级 P0 (必须)
- [ ] 软删除功能部署验证
- [ ] 性能监控和优化

### 优先级 P1 (重要)  
- [ ] 软删除数据恢复界面
- [ ] 批量删除/恢复功能
- [ ] 删除操作审计日志

### 优先级 P2 (可选)
- [ ] 定期数据清理任务
- [ ] 软删除数据分析报表
- [ ] 删除确认增强 (预览影响范围)

## 部署注意事项

### 数据库迁移
1. 执行 `database/soft_delete_schema.sql`
2. 验证索引创建成功
3. 检查现有数据 `is_deleted` 字段默认值

### 功能验证
1. 各模块删除功能测试
2. 级联删除逻辑验证 (话题库)
3. 向量数据同步验证 (知识库)
4. 查询性能验证

### 监控重点
- 查询响应时间变化
- 删除操作成功率  
- 数据一致性检查
- 用户体验反馈 