# 功能地图

## 系统架构概览
```
聊天机器人系统
├── 用户管理模块
├── 机器人人设模块
├── 话题管理模块
├── 知识库模块
├── 聊天对话模块
├── 测试工具模块
└── 系统设置模块
```

## 核心模块功能地图

### 1. 用户管理模块
- **位置**: `src/app/users/`
- **功能**: 管理聊天用户，包括用户信息、标签管理
- **依赖**: 
  - 数据库：`chat_users`, `chat_user_tags`, `chat_user_tag_relations`
  - API：`/api/chat/users`
- **关联**:
  - → 聊天对话模块（用户会话）
  - → 测试工具模块（用户选择）

### 2. 机器人人设模块
- **位置**: `src/app/bots/`
- **功能**: 管理机器人性格、人设、图片等
- **依赖**: 
  - 数据库：`bot_personalities`, `bot_images`, `bot_vectors`
  - API：`/api/bot-personality`
- **关联**:
  - → 聊天对话模块（人设应用）
  - → 测试工具模块（人设选择）

### 3. 话题管理模块
- **位置**: `src/app/topics/`
- **功能**: 管理三级话题结构（大类-小类-话题）
- **依赖**: 
  - 数据库：`topic_categories`, `topic_subcategories`, `topics`
  - API：`/api/topics`
- **关联**:
  - → 聊天对话模块（话题发起）
  - → 测试工具模块（话题选择）
- **重要更新**: 2024-12-19 修正了三级随机选择逻辑

### 4. 知识库模块
- **位置**: `src/app/knowledge/`
- **功能**: 管理话术库、缩写词典等知识内容
- **依赖**: 
  - 数据库：`knowledge_vectors`
  - API：`/api/search`, `/api/vectorize`
- **关联**:
  - → 聊天对话模块（知识检索）
  - → 测试工具模块（向量搜索）

### 5. 聊天对话模块
- **位置**: `src/app/api/chat/`
- **功能**: 核心聊天逻辑，包括消息处理、LLM 调用、向量化
- **依赖**: 
  - 数据库：`chat_sessions`, `chat_messages`, `chat_message_vectors`
  - API：`/api/chat/message`, `/api/chat/sessions`, `/api/chat/vectors`
  - 外部服务：OpenAI API
- **关联**:
  - ← 用户管理模块（用户信息）
  - ← 机器人人设模块（人设信息）
  - ← 话题管理模块（话题内容）
  - ← 知识库模块（知识检索）

### 6. 测试工具模块 **[2024-12-19 重构]**
- **位置**: `src/app/test-chat/`
- **功能**: 聊天功能测试界面，集成所有核心功能
- **依赖**: 
  - 直接数据库访问：supabase 客户端
  - API：复杂操作仍使用 API 调用
- **关联**:
  - ← 用户管理模块（用户选择）
  - ← 机器人人设模块（人设选择）
  - ← 话题管理模块（话题选择）
  - ← 聊天对话模块（消息处理）
- **重要更新**: 
  - 数据访问优化：直接使用 supabase 客户端
  - 话题选择逻辑修正：实现正确的三级随机选择
  - 双语显示格式：`越南文（中文）`

### 7. 系统设置模块
- **位置**: `src/app/settings/`
- **功能**: 系统配置管理
- **依赖**: 
  - 配置文件：`src/lib/config/`
- **关联**:
  - → 所有模块（配置参数）

## 数据流向图

### 聊天对话流程
```
用户输入 → test-chat 页面 → 消息API → 数据库存储 → 后台处理 → LLM调用 → 知识库检索 → 回复生成 → 向量化存储
```

### 话题发起流程 **[2024-12-19 更新]**
```
用户选择话题大类 → 随机选择小类 → 随机选择话题 → 插入消息 → 更新会话状态
```

### 数据访问模式 **[2024-12-19 更新]**
```
简单CRUD操作：前端 → supabase客户端 → 数据库
复杂业务逻辑：前端 → API端点 → 业务处理 → 数据库
```

## 功能依赖关系

### 核心依赖
- **supabase 客户端**: 所有数据库操作的基础
- **OpenAI API**: LLM 调用和向量化
- **LLM 服务**: 封装 OpenAI 调用

### 模块间依赖
- **测试工具** ← 依赖 → **所有其他模块**
- **聊天对话** ← 依赖 → **用户管理** + **人设** + **话题** + **知识库**
- **知识库** ← 依赖 → **向量化服务**

## 性能优化点

### 数据访问优化 **[2024-12-19 新增]**
- **直接数据库访问**: 减少 HTTP 请求开销
- **批量操作**: 合并相关数据库操作
- **智能缓存**: 避免重复数据加载

### 向量化优化
- **异步处理**: 向量化不阻塞主流程
- **批量向量化**: 提高向量化效率
- **相似度阈值**: 优化检索精度

## 扩展计划

### 短期扩展
- [ ] 完善测试工具的错误处理
- [ ] 优化话题选择的权重算法
- [ ] 增强向量搜索的准确性

### 长期扩展
- [ ] 多语言支持扩展
- [ ] 实时聊天功能
- [ ] 聊天数据分析仪表板

## 关键文件映射

### 核心配置
- `src/lib/supabase.ts` - 数据库客户端配置
- `src/lib/config/ai-config.ts` - AI 相关配置
- `src/lib/llm-service.ts` - LLM 服务封装

### 数据库结构
- `database/topics_management_schema.sql` - 话题管理表结构
- `database/chatbot_schema.sql` - 聊天机器人表结构

### API 接口
- `src/app/api/chat/` - 聊天相关 API
- `src/app/api/topics/` - 话题相关 API
- `src/app/api/bot-personality/` - 人设相关 API

### 前端页面
- `src/app/test-chat/page.tsx` - 测试工具页面 **[2024-12-19 重构]**
- `src/app/topics/page.tsx` - 话题管理页面
- `src/app/users/page.tsx` - 用户管理页面